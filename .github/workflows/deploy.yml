name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - staging
          - production

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  NODE_ENV: production
  CI: true

jobs:
  # Pre-deployment validation
  pre-deploy-checks:
    runs-on: ubuntu-latest
    name: Pre-Deployment Validation
    outputs:
      should-deploy: ${{ steps.check.outputs.should-deploy }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check commit message
        id: check
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          if [[ "$COMMIT_MSG" == *"[skip-deploy]"* ]]; then
            echo "should-deploy=false" >> $GITHUB_OUTPUT
          else
            echo "should-deploy=true" >> $GITHUB_OUTPUT
          fi

      - name: Verify main branch
        run: |
          if [[ "${{ github.ref }}" != "refs/heads/main" ]]; then
            echo "Deployments only allowed from main branch"
            exit 1
          fi

  # Build and test before deployment
  build-test:
    runs-on: ubuntu-latest
    name: Build & Test for Production
    needs: pre-deploy-checks
    if: needs.pre-deploy-checks.outputs.should-deploy == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: npm run lint --if-present

      - name: Run type checks
        run: npm run typecheck --if-present

      - name: Run tests
        run: npm test --if-present

      - name: Build production bundle
        run: npm run build --if-present

      - name: Run E2E tests against build
        run: npm run test:e2e --if-present
        continue-on-error: true

  # Deploy to Vercel
  deploy-vercel:
    runs-on: ubuntu-latest
    name: Deploy to Vercel
    needs: build-test
    environment:
      name: production
      url: https://nextjs-starter.vercel.app

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Vercel
        uses: vercel/action@v4
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          scope: ${{ secrets.VERCEL_ORG_ID }}
          production: true

  # Create release and tag
  create-release:
    runs-on: ubuntu-latest
    name: Create GitHub Release
    needs: deploy-vercel
    if: success()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get version from package.json
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        run: |
          COMMITS=$(git log $(git describe --tags --abbrev=0)..HEAD --oneline 2>/dev/null || git log --oneline -10)
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMITS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Release v${{ steps.version.outputs.version }}
          body: |
            # Release v${{ steps.version.outputs.version }}

            **Deployment**: Production
            **Date**: ${{ github.event.head_commit.timestamp }}
            **Commit**: ${{ github.sha }}

            ## Changes
            ${{ steps.changelog.outputs.changelog }}

            **[View on Vercel](https://nextjs-starter.vercel.app)**

          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Post-deployment health check
  health-check:
    runs-on: ubuntu-latest
    name: Post-Deployment Health Check
    needs: deploy-vercel
    if: success()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Health check endpoint
        run: |
          TIMEOUT=0
          MAX_WAIT=300
          HEALTH_URL="https://nextjs-starter.vercel.app/api/health"

          echo "Waiting for deployment to be healthy..."
          while [ $TIMEOUT -lt $MAX_WAIT ]; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" || echo "000")
            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ Deployment is healthy!"
              exit 0
            fi
            echo "Waiting... (attempt $((TIMEOUT/10))/$((MAX_WAIT/10)))"
            sleep 10
            TIMEOUT=$((TIMEOUT + 10))
          done

          echo "‚ùå Deployment health check failed"
          exit 1

  # Notification of successful deployment
  notify-deployment:
    runs-on: ubuntu-latest
    name: Notify Deployment Success
    needs: [deploy-vercel, health-check]
    if: success()

    steps:
      - name: Slack notification
        uses: slackapi/slack-github-action@v1.24.0
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          payload: |
            {
              "text": "Production Deployment Successful",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Production Deployment Successful* ‚úÖ\n*Repository:* ${{ github.repository }}\n*Commit:* <${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Environment:*\nProduction"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Status:*\nHealthy"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Live"
                      },
                      "url": "https://nextjs-starter.vercel.app"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Workflow"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }

  # Notification of deployment failure
  notify-failure:
    runs-on: ubuntu-latest
    name: Notify Deployment Failure
    needs: [deploy-vercel, health-check]
    if: failure()

    steps:
      - name: Slack failure notification
        uses: slackapi/slack-github-action@v1.24.0
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          payload: |
            {
              "text": "Production Deployment Failed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Production Deployment Failed* üî¥\n*Repository:* ${{ github.repository }}\n*Commit:* <${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|${{ github.sha }}>"
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Workflow"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
